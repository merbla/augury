version: "3.2"
services:
  data_science:
    image: cfranklin11/tipresias_data_science:latest
    volumes:
      - "${HOME}/.gcloud:/app/.gcloud"
      # Strictly for being able to access the coverage file generated by python tests
      - ./:/app
    ports:
      - "8008:8008"
    deploy:
      resources:
        limits:
          # We set the memory limit to the max allowed for Google Cloud Run
          # to try to catch potential crashes in CI rather than prod
          memory: 2048M
    depends_on:
      - afl_data
    environment:
      - AFL_DATA_SERVICE=${AFL_DATA_SERVICE}
      - CI=true
      - GOOGLE_APPLICATION_CREDENTIALS="${GOOGLE_APPLICATION_CREDENTIALS}"
    command: python3 app.py
  afl_data:
    image: cfranklin11/tipresias_afl_data:latest
    ports:
      - "8080:8080"
    command: Rscript app.R
